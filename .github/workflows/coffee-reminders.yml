name: Daily Coffee Reminders

on:
  schedule:
    # 02:00 UTC = 7:30 AM IST (Morning)
    - cron: "0 2 * * *"
    # 07:30 UTC = 1:00 PM IST (Afternoon)
    - cron: "30 7 * * *"
    # 13:00 UTC = 6:30 PM IST (Evening)
    - cron: "0 13 * * *"
  workflow_dispatch: # Allows manual testing

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Send Notification
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Determine message based on time of day (UTC)
          HOUR=$(date +%H)

          if [ $HOUR -lt 5 ]; then
             # Morning (approx 02:00 UTC)
             TITLE="Morning Brew ‚òï"
             BODY="Rise and shine! Don't forget to log your morning coffee."
          elif [ $HOUR -lt 12 ]; then
             # Afternoon (approx 07:30 UTC)
             TITLE="Afternoon Pick-me-up? ‚òÄÔ∏è"
             BODY="Powering through the day? Log your afternoon fuel!"
          else
             # Evening (approx 13:00 UTC)
             TITLE="Evening Wind Down üåô"
             BODY="Having a late one? Log your evening brew (or decaf!)."
          fi

          echo "Sending $TITLE..."

          curl -X POST "${SUPABASE_URL}/functions/v1/push-notify" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"broadcast\": true,
              \"title\": \"$TITLE\",
              \"body\": \"$BODY\",
              \"url\": \"/home\",
              \"icon\": \"/logo.png\"
            }"
